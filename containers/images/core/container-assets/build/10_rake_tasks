#! /bin/bash -e

# Enabling collections
. /opt/rh/rh-ruby24/enable
. /opt/rh/rh-nodejs8/enable

export TASKS="db:migrate apipie:cache:index assets:precompile"

# WORKAROUND for dynflow requiring DB access
# http://projects.theforeman.org/issues/23520

yum -y install sqlite-devel
su foreman -s /bin/bash -c 'bundle install --with sqlite'

# use sample settings to avoid memcache miss in logs
mv config/settings.yaml config/settings.yaml.org
mv config/settings.yaml.example config/settings.yaml
# enable organization to true as required by katello
sed -i 's/\:organizations_enabled\: false/\:organizations_enabled\: true/' config/settings.yaml

DATABASE_URL=sqlite3::memory: bundle exec rake ${TASKS}

mv config/settings.yaml.org config/settings.yaml

su foreman -s /bin/bash -c 'bundle install --without sqlite assets'

yum -y history undo `yum history package sqlite-devel |grep Install | awk '{print $1}'`

# END OF WORKAROUND
